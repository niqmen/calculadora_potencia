<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de potencia</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <h1 tabindex="-1">Calculadora de potencia</h1>
  </header>

  <!-- Secci√≥n superior: logo e instrucciones -->
  <section class="branding-section" style="text-align:center; padding:10px 0; border-bottom:1px solid #ddd;">
    <img src="Logo_Asesor_Electricista.webp" alt="Logo Asesor Electricista" style="max-height:56px; margin-bottom:6px;">
    <p class="muted" style="font-size:15px; color:#555;">
      Instrucciones: aumente o disminuya la cantidad de artefactos usando los controles + / ‚àí sobre cada dibujo del artefacto.
    </p>
  </section>

  <div class="main-content">
    <div class="artefactos-section">
      <div id="categories" class="categories">
        <!-- categor√≠as generadas din√°micamente -->
      </div>
    </div>

    <div class="resultados-panel">
      <h2>üìä Resultados del C√°lculo</h2>
      <div class="resultado-item"><span class="resultado-label">Iluminaci√≥n (100%):</span> <span class="resultado-valor" id="potIluminacion">0.00 kW</span></div>
      <div class="resultado-item"><span class="resultado-label">Carga artefactos:</span> <span class="resultado-valor" id="cargaArtefactos">0.00 kW</span></div>
      <div class="resultado-item"><span class="resultado-label">N¬∞ de artefactos:</span> <span class="resultado-valor" id="numArtefactos">0</span></div>
      <div class="resultado-item"><span class="resultado-label">Factor de Carga:</span> <span class="resultado-valor" id="factorSim">0%</span></div>
      <div class="resultado-item"><span class="resultado-label">Artefactos con factor:</span> <span class="resultado-valor" id="potArtefactosFactor">0.00 kW</span></div>
      <div class="resultado-item"><span class="resultado-label">Potencia estimada total:</span> <span class="resultado-valor" id="potenciaEstimada">0.00 kW</span></div>
      <hr>
      <div class="resultado-item"><span class="resultado-label">Mayor equipo:</span> <span class="resultado-valor" id="mayorEquipo">0.00 kW</span></div>
      <div class="resultado-item"><span class="resultado-label">90% de 2 mayores:</span> <span class="resultado-valor" id="dosMayores">0.00 kW</span></div>
      <div class="resultado-item"><span class="resultado-label">80% de 3 mayores:</span> <span class="resultado-valor" id="tresMayores">0.00 kW</span></div>
      <div class="resultado-final">
        <div class="resultado-final-label">‚úÖ POTENCIA M√çNIMA A CONTRATAR</div>
        <div class="resultado-final-valor" id="potenciaFinal">0.00 kW</div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button id="resetAllBottom" class="btn secondary">üîÑ Reiniciar</button>
        <button id="exportSelectionBottom" class="btn">üì• Exportar a XLSX</button>
      </div>
    </div>
  </div>

  <!-- Footer: autor√≠a y enlaces -->
  <footer class="site-footer" role="contentinfo" style="text-align:center; padding:12px 0; border-top:1px solid #ccc; margin-top:30px; font-size:14px; background:#f8f8f8;">
    <p style="margin:0; color:#333;">Desarrollado por <strong>Ing. Niquel Mendoza M.</strong></p>
    <div class="footer-links" style="margin-top:8px;">
      <a href="https://elasesorelectricista.blogspot.com/p/como-solicitar-tu-nuevo-suministro.html" target="_blank" rel="noopener" style="margin:0 8px; color:#0066cc; text-decoration:none;">üåê Blog</a>
      |
      <a href="https://wa.me/51925030742?text=Hola,%20necesito%20asesor√≠a%20el√©ctrica" target="_blank" rel="noopener" style="margin:0 8px; color:#25D366; text-decoration:none;">üí¨ WhatsApp</a>
    </div>
  </footer>

  <!-- SheetJS para exportar -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    let data = [];
    const counts = [];
    const el = {
      categories: document.getElementById('categories'),
      btnResetBottom: document.getElementById('resetAllBottom'),
      btnExportBottom: document.getElementById('exportSelectionBottom'),
      potIluminacion: document.getElementById('potIluminacion'),
      cargaArtefactos: document.getElementById('cargaArtefactos'),
      numArtefactos: document.getElementById('numArtefactos'),
      factorSim: document.getElementById('factorSim'),
      potArtefactosFactor: document.getElementById('potArtefactosFactor'),
      potenciaEstimada: document.getElementById('potenciaEstimada'),
      mayorEquipo: document.getElementById('mayorEquipo'),
      dosMayores: document.getElementById('dosMayores'),
      tresMayores: document.getElementById('tresMayores'),
      potenciaFinal: document.getElementById('potenciaFinal')
    };

    const round2 = v => Math.round((v || 0) * 100) / 100;
    const factorFromCount = n => n === 0 ? 0 : n === 1 ? 1.0 : n === 2 ? 0.9 : n === 3 ? 0.8 : n === 4 ? 0.7 : 0.6;

    async function loadData(){
      try{
        const res = await fetch('salida.json');
        data = await res.json();
      } catch(e){
        alert('No se pudo cargar salida.json: ' + e.message);
        return;
      }
      data.forEach(()=>counts.push(0));
      renderCategories();
      recalcAndRender();
    }

    function renderCategories(){
      const container = el.categories; container.innerHTML = '';
      const map = new Map();
      data.forEach((item, idx) => {
        const cat = item.categoria || 'Sin categor√≠a';
        (map.get(cat) || map.set(cat, []).get(cat)).push({...item, _idx: idx});
      });

      map.forEach((items, categoria) => {
        const catEl = document.createElement('div');
        catEl.className = 'categoria';
        const header = document.createElement('div');
        header.className = 'categoria-header';
        header.textContent = categoria;
        catEl.appendChild(header);
        const grid = document.createElement('div');
        grid.className = 'artefactos-grid';

        items.forEach(it => {
          const card = document.createElement('div');
          card.className = 'artefacto-card';
          card.dataset.index = it._idx;

          const imgWrap = document.createElement('div');
          imgWrap.className = 'image-wrap';
          const img = document.createElement('img');
          img.src = 'img/' + it.nombre_archivo;
          img.alt = it.artefacto || it.nombre_archivo;
          imgWrap.appendChild(img);

          const overlay = document.createElement('div');
          overlay.className = 'controls-overlay';
          const halfPlus = document.createElement('div');
          halfPlus.className = 'overlay-half overlay-plus';
          halfPlus.innerHTML = '<span class="overlay-sign">+</span>';
          const halfMinus = document.createElement('div');
          halfMinus.className = 'overlay-half overlay-minus';
          halfMinus.innerHTML = '<span class="overlay-sign">‚àí</span>';
          overlay.appendChild(halfPlus);
          overlay.appendChild(halfMinus);
          imgWrap.appendChild(overlay);

          card.appendChild(imgWrap);
          const name = document.createElement('div');
          name.className = 'artefacto-nombre';
          name.textContent = niceName(it.artefacto || it.nombre_archivo);
          card.appendChild(name);
          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = '0';
          card.appendChild(badge);

          halfPlus.addEventListener('click', e => {
            e.stopPropagation();
            const i = +card.dataset.index;
            changeCount(i, 1, badge, halfPlus);
          });
          halfMinus.addEventListener('click', e => {
            e.stopPropagation();
            const i = +card.dataset.index;
            changeCount(i, -1, badge, halfMinus);
          });

          card.addEventListener('click', () => {
            const i = +card.dataset.index;
            changeCount(i, 1, badge);
          });
          card.addEventListener('contextmenu', e => {
            e.preventDefault();
            const i = +card.dataset.index;
            changeCount(i, -1, badge);
          });

          grid.appendChild(card);
        });
        catEl.appendChild(grid);
        container.appendChild(catEl);
      });
    }

    function niceName(s){ return (s||'').toString().replace(/([A-Z])/g,' $1').trim(); }

    function changeCount(idx, delta, badge, activeEl){
      counts[idx] = Math.max(0, (counts[idx]||0) + delta);
      if(badge) badge.textContent = counts[idx];
      recalcAndRender();
    }

    function computeStats(){
      const todos = [];
      let carga = 0, ilum = 0;
      data.forEach((d,idx)=>{
        const cant = counts[idx]||0;
        if(!cant) return;
        const pot = parseFloat(d.potencia_kw)||0;
        const isLamp = (d.categoria||'').toLowerCase().includes('ilumin');
        if(isLamp) ilum += cant*pot;
        else {
          for(let i=0; i<cant; i++){ todos.push(pot); carga += pot; }
        }
      });
      todos.sort((a,b)=>b-a);
      const mayor = todos[0]||0;
      const dos = todos.length>=2 ? (todos[0]+todos[1])*0.9 : 0;
      const tres = todos.length>=3 ? (todos[0]+todos[1]+todos[2])*0.8 : 0;
      const factor = factorFromCount(todos.length);
      const potArtefactosFactor = round2(carga*factor);
      const potenciaEstimada = round2(ilum + potArtefactosFactor);
      const potenciaMinima = round2(Math.max(potenciaEstimada, mayor, dos, tres));
      return {carga, ilum, numEquipos: todos.length, factor, potArtefactosFactor, potenciaEstimada, mayor, dos, tres, potenciaMinima};
    }

    function recalcAndRender(){
      const s = computeStats();
      el.potIluminacion.textContent = s.ilum.toFixed(2)+' kW';
      el.cargaArtefactos.textContent = s.carga.toFixed(2)+' kW';
      el.numArtefactos.textContent = s.numEquipos;
      el.factorSim.textContent = (s.factor*100).toFixed(0)+'%';
      el.potArtefactosFactor.textContent = s.potArtefactosFactor.toFixed(2)+' kW';
      el.potenciaEstimada.textContent = s.potenciaEstimada.toFixed(2)+' kW';
      el.mayorEquipo.textContent = s.mayor.toFixed(2)+' kW';
      el.dosMayores.textContent = s.dos.toFixed(2)+' kW';
      el.tresMayores.textContent = s.tres.toFixed(2)+' kW';
      el.potenciaFinal.textContent = s.potenciaMinima.toFixed(2)+' kW';
    }

    function resetAllHandler(){
      for(let i=0; i<counts.length; i++) counts[i]=0;
      document.querySelectorAll('.badge').forEach(b=>b.textContent='0');
      recalcAndRender();
      window.scrollTo(0,0);
    }

    el.btnResetBottom.addEventListener('click', resetAllHandler);
    el.btnExportBottom.addEventListener('click', ()=>alert('Exportar XLSX pendiente.'));
    loadData();
  </script>
</body>
</html>
